<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta http-equiv="Content-Security-Policy"
      content="
        default-src 'self';
        script-src 'self' https://www.youtube.com https://www.youtube-nocookie.com https://s.ytimg.com 'unsafe-inline';
        style-src  'self' 'unsafe-inline';
        img-src    'self' data: blob: https://i.ytimg.com;
        frame-src  https://www.youtube.com https://www.youtube-nocookie.com;
        connect-src 'self' https://www.youtube.com https://*.googlevideo.com;
        media-src  https://*.googlevideo.com;
        font-src   'self' data:;
        object-src 'none';
        base-uri   'self';
        form-action 'self';
      ">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ç¦å³¶ç¬¬ä¸€ ï¼“ï¼¤åŒæœŸæ¯”è¼ƒï¼ˆ2012/2025ï¼‰â€” ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æœ€é©åŒ–</title>
<meta name="description" content="iPhone/Android/PCã§åŒæœŸæœ€å„ªå…ˆã€‚èµ·å‹•ã¯ä½ç”»è³ªâ†’ã‚­ãƒ£ãƒƒã‚·ãƒ¥è“„ç©å¾Œã«æ®µéšã‚¢ãƒƒãƒ—ã€‚åœæ­¢ãƒ•ãƒ¬ãƒ¼ãƒ ä¸€è‡´ã€å…¨ç”»é¢ã§ã‚‚ãƒ•ã‚§ãƒ¼ãƒ‰æ“ä½œã€ç¸¦ç”»é¢ã¯100dvhã§ãƒ•ã‚£ãƒƒãƒˆã€‚" />
<style>
  :root { --bg:#0f1115; --panel:#151822; --muted:#9aa3b2; --fg:#e7ebf3; --accent:#5b9cff; --radius:16px; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:#0f1115;color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans JP,Helvetica,Arial}

  .wrap{max-width:1500px;margin:16px auto;padding:0 12px 40px}
  .header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:10px}
  .title{font-size:clamp(18px,2.8vw,28px);font-weight:800;letter-spacing:.2px}
  .note{color:var(--muted);font-size:12px}

  /* ç–‘ä¼¼ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼ˆiOS/FSå¤±æ•—æ™‚ï¼‰ */
  body.pfs{overflow:hidden;}
  body.pfs .wrap{max-width:none;padding:0}
  body.pfs .video-shell{position:fixed;inset:0;z-index:9999;border-radius:0;width:100vw;height:100dvh;aspect-ratio:auto}
  body.pfs .panel{position:fixed;left:0;right:0;bottom:0;margin:0;border-radius:0}

  .video-shell{
    position:relative;
    width: clamp(320px, 96vw, 1400px);
    margin:0 auto;
    aspect-ratio:16/9;
    background:#0b0d13;border:1px solid #20273a;border-radius:var(--radius);
    overflow:hidden;box-shadow:0 8px 28px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
    isolation:isolate;user-select:none
  }
  .layer{position:absolute;inset:0}
  .layer iframe{position:absolute;inset:0;width:100%;height:100%;border:0;pointer-events:none}
  #video-shell{pointer-events:none}
  .controls,.slider-handle,.fs-btn,.fs-exit,.fs-toolbar{pointer-events:auto}

  /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ */
  .slider-handle{position:absolute;top:0;bottom:0;width:2px;background:#ffffff66;left:50%;cursor:ew-resize;z-index:6}
  .slider-dot{position:absolute;top:50%;transform:translate(-50%,-50%);left:50%;width:18px;height:18px;border-radius:50%;background:#fff;box-shadow:0 0 0 4px rgba(0,0,0,.35)}

  /* åœæ­¢æ™‚ã®æ¥µè–„ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆYouTubeä¸­å¤®ã‚¢ã‚¤ã‚³ãƒ³ã‚’éš ã™ï¼æ˜ åƒã¯è¦‹ãˆã‚‹ï¼‰ */
  #pause-mask{position:absolute;inset:0;background:rgba(0,0,0,0.001);display:none;z-index:5}
  #pause-mask.on{display:block}

  /* ã‚¤ãƒ³ãƒˆãƒ­ */
  #intro{position:absolute;inset:0;display:grid;place-items:center;background:linear-gradient(180deg,#0b0f1a88,#0b0f1a88);z-index:7}
  .intro-box{padding:20px 16px;background:rgba(15,17,23,.55);border:1px solid #20273a;border-radius:14px;backdrop-filter:blur(2px);text-align:center}
  .intro-title{font-weight:800;letter-spacing:.3px;font-size:clamp(16px,3vw,26px);margin-bottom:10px}
  .intro-sub{color:var(--muted);font-size:13px;margin-bottom:8px}
  .bar{height:10px;border-radius:999px;background:#1f2a44;overflow:hidden;margin:8px 0}
  .bar::before{content:"";display:block;height:100%;width:var(--p,0%);background:linear-gradient(90deg,#ff6a6a,#e53935)}
  .intro-row{display:flex;gap:8px;justify-content:center;align-items:center}
  .btn-primary{background:linear-gradient(180deg,#2a6cff,#164cff);color:#fff;border:1px solid #335fff;padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer}
  .btn-primary[disabled]{opacity:.6;cursor:not-allowed}

  /* å…¨ç”»é¢ UI */
  .fs-btn{position:absolute;top:10px;right:10px;z-index:9;background:linear-gradient(180deg,#1a2233,#111725);color:var(--fg);border:1px solid #26324a;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer}
  .fs-exit{position:absolute;top:10px;left:10px;z-index:10;display:none;background:linear-gradient(180deg,#1a2233,#111725);color:var(--fg);border:1px solid #26324a;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer}
  .fs-exit.on{display:block}

  /* FS å°‚ç”¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆãƒ•ã‚§ãƒ¼ãƒ‰ï¼‰ */
  .fs-toolbar{
    position:absolute;left:0;right:0;bottom:8px;z-index:9;
    display:none;gap:10px;align-items:center;justify-content:center;
    padding:8px 10px;
    background:rgba(0,0,0,.25);backdrop-filter:blur(4px)
  }
  .fs-toolbar.on{display:flex}
  .fs-toolbar input[type="range"]{ width:min(520px,80vw); }

  .panel{background:linear-gradient(180deg,#161b27,#121620);border:1px solid #20273a;border-radius:var(--radius);padding:12px;display:grid;gap:10px;box-shadow:0 8px 28px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);margin-top:10px}
  .row{display:grid;gap:8px;align-items:center}
  .row.inline{grid-template-columns:auto 1fr auto;gap:10px}
  .buttons{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  button{background:linear-gradient(180deg,#1a2233,#111725);color:var(--fg);border:1px solid #26324a;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
  button[aria-pressed="true"]{outline:2px solid var(--accent)}
  .seg-btn{border-radius:999px;padding:8px 14px}
  .time{font-variant-numeric:tabular-nums}

  /* ã‚·ãƒ¼ã‚¯ */
  #seek{height:36px;-webkit-appearance:none;background:transparent;border-radius:999px;padding:12px 0;
    background-image:
      linear-gradient(rgba(255,255,255,.25), rgba(255,255,255,.25)),
      linear-gradient(rgba(255,255,255,.60), rgba(255,255,255,.60)),
      linear-gradient(#e53935,#e53935);
    background-repeat:no-repeat;
    background-size:100% 6px, var(--buf,0%) 6px, var(--p,0%) 6px;
    background-position:left center,left center,left center;
  }
  #seek::-webkit-slider-runnable-track{height:6px;background:transparent;border-radius:999px}
  #seek::-moz-range-track{height:6px;background:transparent;border-radius:999px}
  #seek::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:#e53935;border:0;box-shadow:0 0 0 6px rgba(229,57,53,.25)}
  #seek::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:#e53935;border:0;box-shadow:0 0 0 6px rgba(229,57,53,.25)}

  @media (max-width: 480px) {
    .title{ font-size: clamp(16px, 5vw, 22px); }
    .video-shell{ width: 100vw; border-radius: 0; }
    .panel{ margin: 0; border-radius: 0; }
  }

  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
</style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title">ç¦å³¶ç¬¬ä¸€ ï¼“ï¼¤åŒæœŸæ¯”è¼ƒï¼ˆ2012 / 2025ï¼‰â€” ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æœ€é©åŒ–</div>
    </div>

    <div class="video-shell" id="video-shell" aria-label="æ¯”è¼ƒãƒ“ãƒ¥ãƒ¼">
      <!-- å…¨ç”»é¢ UI -->
      <button id="fs-enter" class="fs-btn" aria-label="å…¨ç”»é¢è¡¨ç¤º">â¤¢ å…¨ç”»é¢</button>
      <button id="fs-exit" class="fs-exit" aria-label="å…¨ç”»é¢ã‚’çµ‚äº†">â¤¡ æˆ»ã‚‹</button>

      <div class="layer" id="layer-before"><div id="yt-before"></div></div>
      <div class="layer" id="layer-after"><div id="yt-after"></div></div>

      <!-- ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ -->
      <div class="slider-handle" id="slider-handle" hidden><div class="slider-dot"></div></div>

      <!-- åœæ­¢æ™‚ï¼šä¸­å¤®ã‚¢ã‚¤ã‚³ãƒ³ç­‰ã‚’éš ã™ -->
      <div id="pause-mask" aria-hidden="true"></div>

      <!-- FS å°‚ç”¨ãƒ•ã‚§ãƒ¼ãƒ‰ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆãƒ•ã‚§ãƒ¼ãƒ‰æ¯”è¼ƒæ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
      <div class="fs-toolbar" id="fs-toolbar" aria-hidden="true">
        <label for="fade-range-fs">ãƒ•ã‚§ãƒ¼ãƒ‰</label>
        <input type="range" id="fade-range-fs" min="0" max="100" value="50" step="1" />
        <span id="fade-pct-fs" class="time">50%</span>
      </div>

      <!-- ã‚¤ãƒ³ãƒˆãƒ­ -->
      <div id="intro" role="dialog" aria-modal="true">
        <div class="intro-box">
          <div class="intro-title">åŒæœŸæº–å‚™ä¸­â€¦ï¼ˆèµ·å‹•ã¯ä½ç”»è³ªï¼‰</div>
          <div class="intro-sub" id="intro-sub">ãƒãƒƒãƒ•ã‚¡ã‚’ååˆ†ã«ç¢ºä¿ã—ã¦ã„ã¾ã™</div>
          <div class="bar" id="intro-bar" style="--p:0%"></div>
          <div class="intro-row">
            <button id="intro-start" class="btn-primary" disabled>å†ç”Ÿé–‹å§‹</button>
            <label style="font-size:13px;color:var(--muted)"><input type="checkbox" id="auto-start" checked> æº–å‚™å®Œäº†ã§è‡ªå‹•å†ç”Ÿ</label>
          </div>
        </div>
      </div>
    </div>

    <div class="panel controls">
      <div class="row">
        <div class="buttons" role="group" aria-label="è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰">
          <button id="btn-mode-slider"      class="btn seg-btn" aria-pressed="true">ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ¯”è¼ƒ</button>
          <button id="btn-mode-fade"        class="btn seg-btn" aria-pressed="false">ãƒ•ã‚§ãƒ¼ãƒ‰æ¯”è¼ƒ</button>
          <button id="btn-mode-only-before" class="btn seg-btn" aria-pressed="false">2012ã®ã¿</button>
          <button id="btn-mode-only-after"  class="btn seg-btn" aria-pressed="false">2025ã®ã¿</button>
        </div>
      </div>

      <div class="row inline" id="fade-controls" aria-live="polite" style="display:none">
        <label for="fade-range">ãƒ•ã‚§ãƒ¼ãƒ‰é‡</label>
        <input type="range" id="fade-range" min="0" max="100" value="50" step="1" />
        <span id="fade-pct" class="time">50%</span>
      </div>

      <div class="row" id="transport">
        <div class="transport-buttons" style="display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap">
          <button id="rewind-5">âŸ² -5ç§’</button>
          <button id="play-pause" class="primary" aria-pressed="false">â–¶ å†ç”Ÿ</button>
          <button id="forward-5">+5ç§’ âŸ³</button>
          <button id="resync">ğŸ” å†åŒæœŸ</button>
          <button id="reload">â†º å†èª­ã¿è¾¼ã¿</button>
          <span class="time" id="time-readout">00:00 / 00:00</span>
        </div>
        <input type="range" id="seek" min="0" max="0" value="0" step="0.01" aria-label="ã‚·ãƒ¼ã‚¯ãƒãƒ¼" />
      </div>
    </div>

    <p class="note">
      å‹•ç”»æä¾›:
      <a href="https://youtu.be/WOw9BryHb_4" target="_blank" rel="noreferrer noopener">2012ï¼ˆ2012-03-01æ’®å½±ï¼‰</a>ï¼
      <a href="https://youtu.be/KKNWwr_9590" target="_blank" rel="noreferrer noopener">2025ï¼ˆ2025-01-27æ’®å½±ï¼‰</a>ï¼ˆYouTubeï¼‰
    </p>
  </div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
  // ====== è¨­å®šï¼ˆãƒ‡ãƒã‚¤ã‚¹åˆ¥ã«é–¾å€¤ã‚’æœ€é©åŒ–ï¼‰ ======
  const VIDEO_A = { id:'WOw9BryHb_4', label:'2012' }; // leader
  const VIDEO_B = { id:'KKNWwr_9590',  label:'2025' }; // follower

  const ua = navigator.userAgent;
  const isIOS = /iP(hone|ad|od)/i.test(ua);
  const isAndroid = /Android/i.test(ua);

  // iOSã¯ã‚ˆã‚Šä¿å®ˆçš„ã€Androidã¯ã‚„ã‚„ä¿å®ˆã€PCã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
  const FINE     = isIOS ? 0.10 : isAndroid ? 0.09 : 0.08;
  const HARD     = 0.50;
  const COOLDOWN = isIOS ? 700  : isAndroid ? 600  : 500;

  // å†ç”Ÿé€Ÿåº¦è£œæ­£ï¼ˆiOSã¯ä½¿ã‚ãªã„ï¼‰
  const RATE_NORM=1, RATE_FAST=1.25, RATE_SLOW=0.75;
  const USE_RATE = !isIOS; // iOSã¯é€Ÿåº¦è£œæ­£å°å°
  const RATE_DEAD= 0.10, RATE_MAX_HOLD_MS=3500;

  // ãƒãƒƒãƒ•ã‚¡åŸºæº–
  const MIN_FRAC    = isIOS ? 0.20 : isAndroid ? 0.16 : 0.12;
  const MIN_SEC     = isIOS ? 8    : isAndroid ? 6    : 5;
  const RESYNC_FRAC = isIOS ? 0.30 : isAndroid ? 0.24 : 0.20;
  const RESYNC_SEC  = isIOS ? 12   : isAndroid ? 10   : 8;

  // ç”»è³ªï¼ˆä½â†’é«˜ï¼‰ èµ·å‹•ã¯smallã€‚iOSã¯hd720ã¾ã§
  const QUALITY_ORDER = isIOS ? ['small','medium','large','hd720']
                              : ['small','medium','large','hd720','hd1080'];
  const UPGRADE_FRAC = isIOS ? 0.70 : isAndroid ? 0.65 : 0.60;
  const UPGRADE_STABLE_MS = isIOS ? 12000 : isAndroid ? 10000 : 9000;

  // ====== çŠ¶æ…‹ ======
  let pA=null, pB=null, readyA=false, readyB=false, playing=false;
  let introOn=true, autoStart=true, started=false;
  let raf=null, tickId=null, total=0, lastFine=0;
  let rateMode='norm', rateSince=0, lastHardOrPause=0, stableStart=0;
  const qIndex = { A:0, B:0 }; // small

  // ====== è¦ç´  ======
  const $ = id => document.getElementById(id);
  const shell=$('video-shell'), layerA=$('layer-before'), layerB=$('layer-after');
  const slider=$('slider-handle'), pauseMask=$('pause-mask');
  const playBtn=$('play-pause'), seek=$('seek'), timeReadout=$('time-readout');
  const fadeRange=$('fade-range'), fadePct=$('fade-pct'), fadeRow=$('fade-controls');
  const fadeRangeFS=$('fade-range-fs'), fadePctFS=$('fade-pct-fs'), fsToolbar=$('fs-toolbar');
  const btnSlider=$('btn-mode-slider'), btnFade=$('btn-mode-fade'), btnA=$('btn-mode-only-before'), btnB=$('btn-mode-only-after');
  const intro=$('intro'), introStart=$('intro-start'), introSub=$('intro-sub'), introBar=$('intro-bar');
  const fsEnter=$('fs-enter'), fsExit=$('fs-exit');
  const btnResync=$('resync'), btnReload=$('reload');

  // ====== è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ ======
  let mode='slider';
  function setActive(el,on){ el.setAttribute('aria-pressed', on?'true':'false'); }
  function applySplit(p){ p=Math.max(0,Math.min(100,p)); layerB.style.clipPath=`inset(0 0 0 ${p}%)`; slider.style.left=p+'%'; }
  function syncFadeValue(v){
    fadePct.textContent=v+'%';
    fadePctFS.textContent=v+'%';
    if(mode==='fade'){ layerB.style.opacity=(v/100).toFixed(2); }
  }
  function setMode(m){
    mode=m;
    setActive(btnSlider,m==='slider'); setActive(btnFade,m==='fade'); setActive(btnA,m==='only-a'); setActive(btnB,m==='only-b');
    layerA.style.display=''; layerB.style.display='';
    if(m==='fade'){
      layerB.style.clipPath=''; layerB.style.width='100%';
      syncFadeValue(fadeRange.valueAsNumber);
      slider.hidden=true; fadeRow.style.display=''; updateFsToolbar();
    }else if(m==='slider'){
      fadeRow.style.display='none'; fsToolbar.classList.remove('on');
      slider.hidden=false; layerB.style.opacity=1; applySplit(parseFloat(slider.style.left)||50);
    }else if(m==='only-a'){
      slider.hidden=true; fadeRow.style.display='none'; fsToolbar.classList.remove('on'); layerB.style.display='none';
    }else if(m==='only-b'){
      slider.hidden=true; fadeRow.style.display='none'; fsToolbar.classList.remove('on'); layerB.style.display=''; layerB.style.opacity=1; layerB.style.clipPath='inset(0 0 0 0)';
    }
  }
  btnSlider.onclick=()=>setMode('slider');
  btnFade.onclick=()=>setMode('fade');
  btnA.onclick=()=>setMode('only-a');
  btnB.onclick=()=>setMode('only-b');

  // ãƒ•ã‚§ãƒ¼ãƒ‰å€¤ã®åŒæ–¹å‘åŒæœŸ
  function onFadeInput(v){ fadeRange.value=v; fadeRangeFS.value=v; syncFadeValue(Number(v)); }
  fadeRange.oninput  = e => onFadeInput(e.target.value);
  fadeRangeFS.oninput= e => onFadeInput(e.target.value);

  // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãƒ‰ãƒ©ãƒƒã‚°ï¼ˆãƒ¢ãƒã‚¤ãƒ«ã‚‚ç²¾åº¦è‰¯ãï¼‰
  let dragging=false;
  const down=e=>{ dragging=true; e.preventDefault?.(); };
  const up=()=>{ dragging=false; };
  const move=e=>{
    if(!dragging||mode!=='slider') return;
    e.preventDefault?.();
    const pt=e.touches?e.touches[0]:e;
    const r=shell.getBoundingClientRect(), x=pt.clientX-r.left;
    applySplit(Math.max(0,Math.min(100,(x/r.width)*100)));
  };
  slider.addEventListener('mousedown',down); window.addEventListener('mouseup',up); window.addEventListener('mousemove',move);
  slider.addEventListener('touchstart',down,{passive:false}); window.addEventListener('touchend',up); window.addEventListener('touchmove',move,{passive:false});

  // æ™‚é–“ãƒ»ãƒãƒƒãƒ•ã‚¡UI
  const fmt=s=>{ const t=Math.max(0,Math.floor(s||0)); const m=(t/60)|0, r=t%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`; };
  function updateBar(cur){
    const fA=pA?.getVideoLoadedFraction?.()||0, fB=pB?.getVideoLoadedFraction?.()||0;
    const frac=Math.max(0,Math.min(1,Math.min(fA,fB)));
    const played=Math.max(0,Math.min(1,(cur||0)/total));
    seek.style.setProperty('--buf',(frac*100)+'%'); seek.style.setProperty('--p',(played*100)+'%');
    introBar.style.setProperty('--p',(frac*100)+'%');
  }
  function updateSeek(t){
    if(!Number.isFinite(total)||total<=0) return;
    const c=Math.min(total,Math.max(0,t));
    seek.max=total.toFixed(2); seek.value=c.toFixed(2);
    timeReadout.textContent=`${fmt(c)} / ${fmt(total)} (âˆ’${fmt(Math.max(0,total-c))})`;
    updateBar(c);
  }

  // å†ç”Ÿ/åœæ­¢ï¼ˆåœæ­¢ä½ç½®ã‚’å¿…ãšä¸€è‡´ï¼‰
  function showPauseMask(on){ pauseMask.classList.toggle('on', !!on); }
  function playBoth(){ try{pA.playVideo()}catch{} try{pB.playVideo()}catch{} playing=true; playBtn.textContent='â¸ ä¸€æ™‚åœæ­¢'; playBtn.setAttribute('aria-pressed','true'); showPauseMask(false); startLoops(); }
  function pauseBoth(){ try{pA.pauseVideo()}catch{} try{pB.pauseVideo()}catch{} playing=false; playBtn.textContent='â–¶ å†ç”Ÿ'; playBtn.setAttribute('aria-pressed','false'); showPauseMask(true); stopLoops(); }
  $('play-pause').onclick=()=>{ if(!(readyA&&readyB) || introOn) return; playing?pauseBoth():playBoth(); };
  $('rewind-5').onclick=()=>nudge(-5);
  $('forward-5').onclick=()=>nudge(+5);
  btnResync.onclick=()=>forceSyncNow();
  btnReload.onclick=()=>location.reload();

  function nudge(d){
    if(!(readyA&&readyB)) return;
    const t=Math.max(0,Math.min(total,(pA.getCurrentTime?.()||0)+d));
    seekBoth(t,true);
  }
  seek.addEventListener('input',()=>updateSeek(parseFloat(seek.value)));
  seek.addEventListener('change',()=>seekBoth(parseFloat(seek.value),true));

  function forceSyncOnPause(){
    const t=pA.getCurrentTime?.()||0; // leader ã®æ™‚é–“
    pB.seekTo(t,false);
    updateSeek(t);
    lastHardOrPause = performance.now();
  }
  function forceSyncNow(){
    // å†ç”Ÿ/åœæ­¢çŠ¶æ…‹ã«é–¢ã‚ã‚‰ãšã€ãã®å ´ã§ãƒ”ã‚¿ãƒƒã¨åˆã‚ã›ã‚‹
    const t=pA.getCurrentTime?.()||0;
    pB.seekTo(t,true);
    updateSeek(t);
  }

  // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼ˆiOSã¯å¸¸ã«ç–‘ä¼¼ã€ä»–ã¯ãƒã‚¤ãƒ†ã‚£ãƒ–â†’å¤±æ•—æ™‚ã¯ç–‘ä¼¼ï¼‰
  function inNativeFS(){ return !!(document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement); }
  function reqNative(el){
    const f=el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen||el.mozRequestFullScreen;
    try{ f?.call(el); return !!f; }catch{ return false; }
  }
  function exitNative(){
    const f=document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen||document.mozCancelFullScreen;
    try{ f?.call(document); return !!f; }catch{ return false; }
  }
  function enterPFS(){ document.body.classList.add('pfs'); fsExit.classList.add('on'); updateFsToolbar(); }
  function exitPFS(){ document.body.classList.remove('pfs'); fsExit.classList.remove('on'); updateFsToolbar(); }
  function inAnyFS(){ return inNativeFS() || document.body.classList.contains('pfs'); }
  function toggleFS(){
    if(isIOS){ if(document.body.classList.contains('pfs')) exitPFS(); else enterPFS(); return; }
    if(inNativeFS()){ exitNative(); return; }
    if(!reqNative(shell)) enterPFS();
  }
  $('fs-enter').onclick=toggleFS;
  $('fs-exit').onclick=()=>{ exitNative(); exitPFS(); };
  document.addEventListener('fullscreenchange', ()=>{ $('fs-exit').classList.toggle('on', inAnyFS()); updateFsToolbar(); });

  function updateFsToolbar(){ if(inAnyFS() && mode==='fade'){ fsToolbar.classList.add('on'); } else { fsToolbar.classList.remove('on'); } }

  // ç”»è³ªåˆ¶å¾¡ï¼ˆæ®µéšã‚¢ãƒƒãƒ—ï¼ãƒ€ã‚¦ãƒ³ï¼‰
  function applyQuality(p, which, idx){
    qIndex[which] = Math.max(0, Math.min(QUALITY_ORDER.length-1, idx));
    try{ p.setPlaybackQuality?.(QUALITY_ORDER[qIndex[which]]); }catch{}
  }
  function lowerQualityIfNeeded(){
    const now = performance.now();
    if(now - lastHardOrPause < 1200) return; // ç›´å¾Œã¯æ§˜å­è¦‹
    const fA=pA.getVideoLoadedFraction?.()||0, fB=pB.getVideoLoadedFraction?.()||0;
    if(fA<MIN_FRAC || fB<MIN_FRAC){
      if(qIndex.A>0) applyQuality(pA,'A',qIndex.A-1);
      if(qIndex.B>0) applyQuality(pB,'B',qIndex.B-1);
    }
  }
  function maybeUpgradeQuality(driftAbs){
    const fA=pA.getVideoLoadedFraction?.()||0, fB=pB.getVideoLoadedFraction?.()||0;
    const now = performance.now();
    if(fA>=UPGRADE_FRAC && fB>=UPGRADE_FRAC && driftAbs<=FINE){
      if(stableStart===0) stableStart = now;
      if(now - stableStart >= UPGRADE_STABLE_MS){
        if(qIndex.A < QUALITY_ORDER.length-1) applyQuality(pA,'A',qIndex.A+1);
        if(qIndex.B < QUALITY_ORDER.length-1) applyQuality(pB,'B',qIndex.B+1);
        stableStart = 0;
      }
    }else{
      stableStart = 0;
    }
  }

  // ãƒãƒƒãƒ•ã‚¡åˆ¤å®š
  function bufferedEnough(p, frac=MIN_FRAC, sec=MIN_SEC){
    const d=p.getDuration?.()||0, f=p.getVideoLoadedFraction?.()||0;
    const have=Math.max(f*d, p.getCurrentTime?.()||0);
    const need=Math.max(frac*d, sec);
    return have>=need;
  }

  // åŒæœŸåŸºæœ¬æ“ä½œ
  function seekBoth(t, allow){ pA.seekTo(t,allow); pB.seekTo(t,allow); updateSeek(t); }
  function setRate(p, r){ try{ p.setPlaybackRate?.(r); }catch{} }

  // ====== åŒæœŸãƒ«ãƒ¼ãƒ—ï¼ˆrAF + iOSã¯intervalä½µç”¨ï¼‰ ======
  function syncStep(){
    const stA=pA.getPlayerState?.(), stB=pB.getPlayerState?.();
    const tA=pA.getCurrentTime?.()||0, tB=pB.getCurrentTime?.()||0;

    // ã©ã¡ã‚‰ã‹ãŒçµ‚ç«¯è¿‘è¾ºã«åˆ°é”ã—ãŸã‚‰ã€ä¸¡è€…ã‚’0ã¸æˆ»ã—ã¦å³å†ç”Ÿï¼ˆãƒ«ãƒ¼ãƒ—å …ç‰¢åŒ–ï¼‰
    if(total>0){
      const near = 0.35; // ç§’
      if((total - tA) <= near || (total - tB) <= near){
        pA.seekTo(0,true); pB.seekTo(0,true);
        if(playing){ try{pA.playVideo()}catch{} try{pB.playVideo()}catch{} }
        updateSeek(0);
        lastHardOrPause = performance.now();
        return;
      }
    }

    if(stA!==YT.PlayerState.PLAYING || stB!==YT.PlayerState.PLAYING){
      updateSeek(tA); return;
    }

    if(!(bufferedEnough(pA) && bufferedEnough(pB))){
      // ãƒãƒƒãƒ•ã‚¡ãŒè–„ã„ã¨ãã¯ä¸€æ—¦æ­¢ã‚ã¦ã€ååˆ†ã«æºœã¾ã‚‹ã¾ã§å¾…ã¤
      pauseBoth();
      const id=setInterval(()=>{
        if(bufferedEnough(pA,RESYNC_FRAC,RESYNC_SEC) && bufferedEnough(pB,RESYNC_FRAC,RESYNC_SEC)){
          clearInterval(id);
          seekBoth(pA.getCurrentTime?.()||0, true);
          playBoth();
        }
      },250);
      return;
    }

    const drift = tB - tA;
    const abs   = Math.abs(drift);
    const now   = performance.now();

    if(abs > HARD){
      pB.seekTo(tA,true);
      if(USE_RATE){ setRate(pB, RATE_NORM); rateMode='norm'; rateSince=now; }
      lastHardOrPause = now;
    }
    else if(abs > FINE && (now - lastFine) > COOLDOWN){
      pB.seekTo(tA,false);
      lastFine=now;
    }
    else if(USE_RATE){
      let want='norm';
      if(drift >  RATE_DEAD) want='fast';
      if(drift < -RATE_DEAD) want='slow';
      if(want!==rateMode || (now-rateSince)>RATE_MAX_HOLD_MS){
        rateMode=want; rateSince=now;
        if(want==='fast') setRate(pB,RATE_FAST);
        else if(want==='slow') setRate(pB,RATE_SLOW);
        else setRate(pB,RATE_NORM);
      }
    }

    lowerQualityIfNeeded();
    maybeUpgradeQuality(abs);
    updateSeek(tA);
  }
  function rAFLoop(){ syncStep(); raf=requestAnimationFrame(rAFLoop); }
  function startLoops(){
    if(!raf) raf=requestAnimationFrame(rAFLoop);
    if(isIOS && !tickId){ tickId=setInterval(syncStep, 180); } // iOSã¯backup tick
  }
  function stopLoops(){
    if(raf){ cancelAnimationFrame(raf); raf=null; }
    if(tickId){ clearInterval(tickId); tickId=null; }
  }

  // ã‚¤ãƒ³ãƒˆãƒ­
  function updateIntro(){
    const fA=pA?.getVideoLoadedFraction?.()||0, fB=pB?.getVideoLoadedFraction?.()||0;
    const f=Math.max(0,Math.min(1,Math.min(fA,fB)));
    introBar.style.setProperty('--p',(f*100)+'%');
    return f;
  }
  function begin(){
    if(started) return; started=true;
    pA.seekTo(0,true); pB.seekTo(0,true);
    playBoth();
    introOn=false; intro.style.display='none';
  }

  // YouTube IFrame API
  window.onYouTubeIframeAPIReady=function(){
    const pv={ autoplay:1, controls:0, rel:0, modestbranding:1, playsinline:1, fs:0, iv_load_policy:3, loop:1, disablekb:1, cc_load_policy:0, origin:location.origin };
    pA=new YT.Player('yt-before',{ videoId:VIDEO_A.id, playerVars:{...pv, playlist:VIDEO_A.id}, events:{ onReady:e=>onReady('A',e), onStateChange:onState }});
    pB=new YT.Player('yt-after' ,{ videoId:VIDEO_B.id, playerVars:{...pv, playlist:VIDEO_B.id}, events:{ onReady:e=>onReady('B',e), onStateChange:onState }});
  };
  function onReady(which,e){
    try{ e.target.mute(); }catch{}
    try{ e.target.setPlaybackQuality('small'); }catch{}
    if(which==='A') readyA=true; else readyB=true;

    if(readyA && readyB){
      const dA=pA.getDuration?.()||0, dB=pB.getDuration?.()||0;
      total=Math.min(dA||0,dB||0); updateSeek(0);
      setMode('slider'); applySplit(50);

      const id=setInterval(()=>{
        const f=updateIntro();
        if( f>=MIN_FRAC && bufferedEnough(pA) && bufferedEnough(pB) ){
          clearInterval(id);
          introSub.textContent = 'æº–å‚™å®Œäº†';
          $('intro-start').disabled=false;
          if(autoStart){ setTimeout(()=>{ if(introOn) begin(); }, 600); }
        } else {
          introSub.textContent = 'åŒæœŸæº–å‚™ä¸­â€¦ ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°ä¸­ï¼ˆä½ç”»è³ªã§é–‹å§‹ï¼‰';
        }
      },180);
    }
  }
  function onState(ev){
    if(!(pA&&pB)) return;
    const st=ev.data;
    if(st===YT.PlayerState.PAUSED){ forceSyncOnPause(); pauseBoth(); }
    if(st===YT.PlayerState.PLAYING){ if(!playing && !introOn) playBoth(); showPauseMask(false); }
    if(st===YT.PlayerState.ENDED){
      // å¿µã®ãŸã‚ã®äºŒé‡ä¿é™ºï¼šçµ‚äº†ã‚¤ãƒ™ãƒ³ãƒˆã§ã‚‚ç¢ºå®Ÿã«ãƒ«ãƒ¼ãƒ—
      pA.seekTo(0,true); pB.seekTo(0,true);
      playBoth();
      updateSeek(0);
    }
  }

  // ã‚¤ãƒ³ãƒˆãƒ­æ“ä½œ
  $('intro-start').onclick=()=>begin();
  $('auto-start').onchange=(e)=>{ autoStart=!!e.target.checked; };

  // ã‚¿ãƒ–éè¡¨ç¤ºæ™‚ã®ç¯€é›»ï¼šiOSãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—tickã‚’æ­¢ã‚ã‚‹
  document.addEventListener('visibilitychange', ()=>{
    if(document.hidden){ if(tickId){ clearInterval(tickId); tickId=null; } }
    else if(isIOS && playing && !tickId){ tickId=setInterval(syncStep,180); }
  });

  // ãƒšãƒ¼ã‚¸é›¢è„±
  window.addEventListener('beforeunload',()=>{ stopLoops(); });
  </script>
</body>
</html>
